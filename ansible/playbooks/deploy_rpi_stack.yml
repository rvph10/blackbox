---
- name: Deploy Raspberry Pi Stack
  hosts: raspberry
  become: true

  tasks:
    # --- 1. System preparation (Port 53) ---
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Disable systemd-resolved (Release port 53 for AdGuard)
      ansible.builtin.service:
        name: systemd-resolved
        state: stopped
        enabled: false
      when: "'systemd-resolved.service' in services"
      ignore_errors: true  # noqa: ignore-errors

    - name: Remove symbolic link resolv.conf managed by systemd
      ansible.builtin.file:
        path: /etc/resolv.conf
        state: absent
      ignore_errors: true  # noqa: ignore-errors

    - name: Create a new temporary resolv.conf (Cloudflare)
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: "nameserver 1.1.1.1"
        mode: "0644"
      # We do this so the Pi keeps internet access while AdGuard is launching

    # --- 2. Directory Structure ---
    - name: Create data directories on NFS mount
      ansible.builtin.file:
        path: "/mnt/appdata/{{ item }}"
        state: directory
        mode: "0755"

      loop:
        - adguard/work
        - adguard/conf
        - homeassistant/config
        - homepage/config
        - grafana
        - prometheus/config
        - prometheus/data
        - loki/config
        - loki/data

    # --- 3. Deploy Configurations ---
    - name: Configure Prometheus
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/prometheus.yml.j2"  # noqa: no-relative-paths
        dest: /mnt/appdata/prometheus/config/prometheus.yml
        mode: "0644"

    - name: Configure Alert Rules
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/alert_rules.yml.j2"  # noqa: no-relative-paths
        dest: /mnt/appdata/prometheus/config/alert_rules.yml
        mode: "0644"

    - name: Configure Alertmanager
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/alertmanager.yml.j2"  # noqa: no-relative-paths
        dest: /mnt/appdata/prometheus/config/alertmanager.yml
        mode: "0644"

    - name: Configure Loki
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/loki.yml.j2"  # noqa: no-relative-paths
        dest: /mnt/appdata/loki/config/loki.yml
        mode: "0644"

    - name: Configure Promtail
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/promtail-config.yml.j2"  # noqa: no-relative-paths
        dest: /mnt/appdata/loki/config/promtail-config.yml
        mode: "0644"

    # --- 4. Deploy Docker ---
    - name: Copy docker-compose file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi/docker-compose.yml.j2"  # noqa: no-relative-paths
        dest: /opt/blackbox/docker-compose.yml
        owner: "{{ ansible_user }}"
        group: docker
        mode: "0640"

    - name: Launch Docker stack
      community.docker.docker_compose_v2:
        project_src: /opt/blackbox
        state: present
        pull: always
