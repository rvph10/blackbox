---
- name: Deploying Observability Stack
  hosts: raspberry
  become: yes

  tasks:
    # --- 1. Preparing directories on NAS (via NFS mount) ---
    - name: Creating configuration and data directories
      ansible.builtin.file:
        path: "/mnt/appdata/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - grafana
        - prometheus/config
        - prometheus/data
        - loki/config
        - loki/data

    # --- 2. Deploying configuration templates ---
    - name: Configuring Prometheus
      ansible.builtin.template:
        src: ../templates/rpi/prometheus.yml.j2
        dest: /mnt/appdata/prometheus/config/prometheus.yml
        mode: "0644"

    - name: Configuring Loki
      ansible.builtin.template:
        src: ../templates/rpi/loki.yml.j2
        dest: /mnt/appdata/loki/config/loki.yml
        mode: "0644"

    - name: Configuring Promtail
      ansible.builtin.template:
        src: ../templates/rpi/promtail-config.yml.j2
        dest: /mnt/appdata/loki/config/promtail-config.yml
        mode: "0644"

    # --- 3. Update and launch Docker stack ---
    - name: Updating docker-compose file
      ansible.builtin.template:
        src: ../templates/rpi/docker-compose.yml.j2
        dest: /opt/blackbox/docker-compose.yml
        mode: "0640"

    - name: Launching observability services
      community.docker.docker_compose_v2:
        project_src: /opt/blackbox
        state: present
        pull: always
