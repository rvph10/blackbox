---
- name: Post-Install Proxmox Configuration (GMKtec M6)
  hosts: proxmox
  become: yes
  vars:
    # Debian Trixie for Proxmox 9.1
    pve_distribution: "trixie"

  tasks:
    # --- Section 1: SSH Configuration ---
    - name: Ensure .ssh directory exists for root
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: "0700"
        owner: root
        group: root

    - name: Configure authorized SSH key for root
      ansible.builtin.authorized_key:
        user: root
        key: "{{ vault_ssh_public_key }}"
        state: present

    - name: Configure SSH for better security
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - {
            regexp: "^#?PasswordAuthentication",
            line: "PasswordAuthentication no",
          }
        - {
            regexp: "^#?PermitRootLogin",
            line: "PermitRootLogin prohibit-password",
          }
        - {
            regexp: "^#?ChallengeResponseAuthentication",
            line: "ChallengeResponseAuthentication no",
          }
        - {
            regexp: "^#?PubkeyAuthentication",
            line: "PubkeyAuthentication yes",
          }
      notify: Restart SSH

    # --- Section 2: Local DNS Configuration ---
    - name: Add local DNS entry to /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: "^{{ vault_pve_ip | regex_escape }}"
        line: "{{ vault_pve_ip }}    {{ vault_pve_hostname }} {{ vault_pve_alias }}"
        state: present

    # --- Section 3.A: Repository Management ---
    - name: Disable Enterprise repository
      ansible.builtin.apt_repository:
        repo: "deb https://enterprise.proxmox.com/debian/pve {{ pve_distribution }} pve-enterprise"
        state: absent
        filename: pve-enterprise

    - name: Add No-Subscription repository
      ansible.builtin.apt_repository:
        repo: "deb http://download.proxmox.com/debian/pve {{ pve_distribution }} pve-no-subscription"
        state: present
        filename: pve-no-subscription
        update_cache: yes

    # --- Section 3.B: IOMMU Activation ---
    - name: Configure GRUB for AMD IOMMU
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: "^GRUB_CMDLINE_LINUX_DEFAULT="
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on"'
      notify: Update GRUB

    # --- Section 4: System Update ---
    - name: Update APT cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Update all packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub

    - name: Restart SSH
      ansible.builtin.service:
        name: sshd
        state: restarted
