services:
  # --- DNS & Security ---
  adguard:
    container_name: adguard
    image: adguard/adguardhome
    restart: unless-stopped
    network_mode: host
    volumes:
      - /mnt/appdata/adguard/work:/opt/adguardhome/work
      - /mnt/appdata/adguard/conf:/opt/adguardhome/conf
    # Ports used (via host mode) :
    # 53 (DNS), 80 (Web Admin), 3000 (Setup initial)

  # --- Home Automation ---
  homeassistant:
    container_name: homeassistant
    image: ghcr.io/home-assistant/home-assistant:stable
    restart: unless-stopped
    network_mode: host
    privileged: true
    volumes:
      - /mnt/appdata/homeassistant/config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro

  # --- Monitoring Dashboard ---
  homepage:
    container_name: homepage
    image: ghcr.io/gethomepage/homepage:latest
    restart: unless-stopped
    ports:
      # Move Homepage to {{ port_homepage }} to avoid conflict with AdGuard (port 3000)
      - "{{ port_homepage }}:3000"
    environment:
      HOMEPAGE_ALLOWED_HOSTS: "*"
    volumes:
      - /mnt/appdata/homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # --- Monitoring ---
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - /mnt/appdata/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml
      - /mnt/appdata/prometheus/data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    ports:
      - "{{ port_prometheus }}:9090"

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    volumes:
      - /mnt/appdata/prometheus/config/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "{{ port_alertmanager }}:9093"

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    volumes:
      - /mnt/appdata/loki/config/loki.yml:/etc/loki/local-config.yaml
      - /mnt/appdata/loki/data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "{{ port_loki }}:3100"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD={{ vault_grafana_password | default('admin') }}
    volumes:
      - /mnt/appdata/grafana:/var/lib/grafana
    ports:
      - "{{ port_grafana }}:3000"

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/appdata/loki/config/promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml